==============
|package_name|
==============

:ir_github:`<isaac_ros_object_detection> <isaac_ros_grounding_dino>`

Quickstart
----------

Set Up Development Environment
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /_snippets/set_up_dev_env.rst

Download Quickstart Assets
~~~~~~~~~~~~~~~~~~~~~~~~~~

#. Download quickstart data from NGC:

   :ir_assets:`<isaac_ros_grounding_dino> <quickstart.tar.gz>`

Build |package_name|
~~~~~~~~~~~~~~~~~~~~

.. tabs::

   .. tab:: Binary Package

      #. Activate the Isaac ROS environment:

         .. code:: bash

            isaac-ros activate

      #. Install the prebuilt Debian package:

         :ir_apt:

         .. code:: bash

            sudo apt-get install -y ros-:ir_ros_distro:-isaac-ros-grounding-dino && \
               sudo apt-get install -y ros-:ir_ros_distro:-isaac-ros-grounding-dino-models-install

      #. Download and set up (convert ONNX to TensorRT engine plan) the pre-trained Grounding DINO model:

         :ir_apt:

         .. code:: bash

            ros2 run isaac_ros_grounding_dino_models_install install_grounding_dino_models.sh --eula

         .. note::

            The time taken to convert the ONNX model to a TensorRT engine plan varies across different platforms. On Jetson AGX Thor, for example, the engine conversion process can take up to 10-15 minutes to complete.

   .. tab:: Build from Source

      #. Install Git LFS:

         .. code:: bash

            sudo apt-get install -y git-lfs && git lfs install

      #. Clone this repository under ``${ISAAC_ROS_WS}/src``:

         .. code:: bash

            cd ${ISAAC_ROS_WS}/src && \
               git clone :ir_clone:`<isaac_ros_object_detection>`

      #. Activate the Isaac ROS environment:

         .. code:: bash

            isaac-ros activate

      #. Use ``rosdep`` to install the package's dependencies:

         :ir_apt:

         .. code:: bash

            rosdep update && rosdep install --from-paths ${ISAAC_ROS_WS}/src/isaac_ros_object_detection/isaac_ros_grounding_dino --ignore-src -y

      #. Download and set up (convert ONNX to TensorRT engine plan) the pre-trained Grounding DINO model:

         .. code:: bash

            sudo apt-get install -y ros-:ir_ros_distro:-isaac-ros-grounding-dino-models-install && \
               ros2 run isaac_ros_grounding_dino_models_install install_grounding_dino_models.sh --eula

         .. note::

            The time taken to convert the ONNX model to a TensorRT engine plan varies across different platforms. On Jetson AGX Thor, for example, the engine conversion process can take up to 10-15 minutes to complete.

      #. Build the package from source:

         .. code:: bash

            cd ${ISAAC_ROS_WS} && \
               colcon build --symlink-install --packages-up-to isaac_ros_grounding_dino --base-paths ${ISAAC_ROS_WS}/src/isaac_ros_object_detection/isaac_ros_grounding_dino

      #. Source the ROS workspace:

         .. note::

            Make sure to repeat this step in **every** terminal created inside the Isaac ROS environment.

            Since this package was built from source, the enclosing workspace must be sourced for ROS to be able to find the package's contents.

         .. code:: bash

            source install/setup.bash

Run Launch File
~~~~~~~~~~~~~~~

.. tabs::

   .. tab:: Rosbag

      #. Continuing inside the Isaac ROS environment, install the following dependencies:

         :ir_apt:

         .. code:: bash

            sudo apt-get install -y ros-:ir_ros_distro:-isaac-ros-examples

      #. Run the following launch file to spin up a demo of this package using the quickstart rosbag:

         .. code:: bash

            ros2 launch isaac_ros_examples isaac_ros_examples.launch.py launch_fragments:=grounding_dino interface_specs_file:=${ISAAC_ROS_WS}/isaac_ros_assets/isaac_ros_grounding_dino/quickstart_interface_specs.json model_file_path:=${ISAAC_ROS_WS}/isaac_ros_assets/models/grounding_dino/grounding_dino_model.onnx engine_file_path:=${ISAAC_ROS_WS}/isaac_ros_assets/models/grounding_dino/grounding_dino_model.plan

      #. Open a **second** terminal inside the Isaac ROS environment:

         .. code:: bash

            isaac-ros activate

      #. Run the rosbag file to simulate an image stream:

         .. code:: bash

            ros2 bag play -l ${ISAAC_ROS_WS}/isaac_ros_assets/isaac_ros_grounding_dino/quickstart.bag

   .. tab:: RealSense Camera

      #. Ensure that you have already set up your RealSense camera using the :doc:`RealSense setup tutorial </getting_started/sensors/realsense_setup>`. If you have not, please set up the sensor and then restart this quickstart from the beginning.

      #. Continuing inside the Isaac ROS environment, install the following dependencies:

         :ir_apt:

         .. code:: bash

            sudo apt-get install -y ros-:ir_ros_distro:-isaac-ros-examples ros-:ir_ros_distro:-isaac-ros-realsense

      #. Run the following launch file to spin up a demo of this package using a RealSense camera:

         .. code:: bash

            ros2 launch isaac_ros_examples isaac_ros_examples.launch.py launch_fragments:=realsense_mono_rect,grounding_dino model_file_path:=${ISAAC_ROS_WS}/isaac_ros_assets/models/grounding_dino/grounding_dino_model.onnx engine_file_path:=${ISAAC_ROS_WS}/isaac_ros_assets/models/grounding_dino/grounding_dino_model.plan

   .. tab:: ZED Camera

      #. Ensure that you have already set up your ZED camera using :doc:`ZED setup tutorial </getting_started/sensors/zed_setup>`.

      #. Continuing inside the Isaac ROS environment, install dependencies:

         :ir_apt:

         .. code:: bash

            sudo apt-get install -y ros-:ir_ros_distro:-isaac-ros-examples ros-:ir_ros_distro:-isaac-ros-image-proc ros-:ir_ros_distro:-isaac-ros-zed

      #. Run the following launch file to spin up a demo of this package using a ZED Camera:

         .. code:: bash

            ros2 launch isaac_ros_examples isaac_ros_examples.launch.py \
            launch_fragments:=zed_mono_rect,grounding_dino model_file_path:=${ISAAC_ROS_WS}/isaac_ros_assets/models/grounding_dino/grounding_dino_model.onnx engine_file_path:=${ISAAC_ROS_WS}/isaac_ros_assets/models/grounding_dino/grounding_dino_model.plan \
            interface_specs_file:=${ISAAC_ROS_WS}/isaac_ros_assets/isaac_ros_grounding_dino/zed2_quickstart_interface_specs.json

         .. note::

            If you are using the `ZED X` series, replace  `zed2_quickstart_interface_specs.json` with `zedx_quickstart_interface_specs.json` in the above command.

Visualize Results
^^^^^^^^^^^^^^^^^

#. Open a **new** terminal inside the Isaac ROS environment:

   .. code:: bash

      isaac-ros activate

#. Install ``cv_bridge``:

   .. code:: bash

      sudo apt-get install -y ros-:ir_ros_distro:-cv-bridge

#. Run the Grounding DINO visualization script:

   .. code:: bash

      ros2 run isaac_ros_grounding_dino isaac_ros_grounding_dino_visualizer.py

#. Open **another** terminal inside the Isaac ROS environment:

   .. code:: bash

      isaac-ros activate

#. Install ``rqt_image_view``:

   .. code:: bash

      sudo apt-get install -y ros-:ir_ros_distro:-rqt-image-view

#. Visualize and validate the output of the package with ``rqt_image_view``:

   .. code:: bash

      ros2 run rqt_image_view rqt_image_view /grounding_dino_processed_image

   Your output should look like this:

   .. figure:: :ir_lfs:`<resources/isaac_ros_docs/repositories_and_packages/isaac_ros_object_detection/isaac_ros_grounding_dino/rqt_visualizer.png>`
      :alt: RQT showing detection of various objects
      :align: center

#. Open **another** terminal inside the Isaac ROS environment:

   .. code:: bash

      isaac-ros activate

#. Dynamically change the prompt using the ``set_prompt`` service:

   .. code:: bash

      ros2 service call /set_prompt isaac_ros_grounding_dino_interfaces/srv/SetPrompt "{prompt: 'shopping bag.person.'}"

.. note::

   Grounding DINO is designed to perform object detection on previously unseen objects without model retraining.
   As a result, inference requires significant GPU compute.
   Refer to :ir_repo:`performance <isaac_ros_object_detection> <README.md#performance>` of
   the model for your target platform to determine which model to use.

   More powerful discrete GPUs can outperform all other platforms for this task and should be preferred if higher performance is required.
   Interleaving object detection with other tasks rather than running continuously can be a more effective solution as well. Finally, if runtime performance
   is critical and offline training resources are available, developers can train :doc:`RT-DETR </repositories_and_packages/isaac_ros_object_detection/isaac_ros_rtdetr/index>`
   for their own target objects using synthetic data generation and/or real-world data for faster object detection.

Troubleshooting
---------------

Isaac ROS Troubleshooting
~~~~~~~~~~~~~~~~~~~~~~~~~

For solutions to problems with Isaac ROS, see :doc:`troubleshooting </troubleshooting/index>`.

Deep Learning Troubleshooting
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

For solutions to problems with using DNN models, see :doc:`troubleshooting deeplearning </troubleshooting/deep_learning>`.

API
----

Usage
~~~~~

.. code:: bash

   ros2 launch isaac_ros_grounding_dino isaac_ros_grounding_dino.launch.py model_file_path:=<path to .onnx> engine_file_path:=<path to .plan> input_image_width:=<input image width> input_image_height:=<input image height> network_image_width:=<network image width> network_image_height:=<network image height> input_tensor_names:=<input tensor names> input_binding_names:=<input binding names> output_tensor_names:=<output tensor names> output_binding_names:=<output binding names> tensorrt_verbose:=<TensorRT verbosity> force_engine_update:=<force TensorRT update> confidence_threshold:=<confidence threshold>

GroundingDinoPreprocessorNode
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

ROS Parameters
^^^^^^^^^^^^^^

.. list-table::
   :header-rows: 1

   * - ROS Parameter
     - Type
     - Default
     - Description

   * - ``default_prompt``
     - ``string``
     - ``''``
     - The default text prompt to use for object detection.

   * - ``service_call_timeout``
     - ``int``
     - ``5``
     - The timeout (in seconds) for the GetTextTokens service call.

   * - ``service_discovery_timeout``
     - ``int``
     - ``5``
     - The timeout (in seconds) for the GetTextTokens service discovery.

ROS Topics Subscribed
^^^^^^^^^^^^^^^^^^^^^

.. list-table::
   :header-rows: 1

   * - ROS Topic
     - Interface
     - Description

   * - ``image_tensor``
     - :ir_repo:`isaac_ros_tensor_list_interfaces/TensorList <isaac_ros_common> <isaac_ros_tensor_list_interfaces/msg/TensorList.msg>`
     - The tensor that contains the encoded image data.

ROS Topics Published
^^^^^^^^^^^^^^^^^^^^

.. list-table::
   :header-rows: 1

   * - ROS Topic
     - Interface
     - Description

   * - ``tensor_pub``
     - :ir_repo:`isaac_ros_tensor_list_interfaces/TensorList <isaac_ros_common> <isaac_ros_tensor_list_interfaces/msg/TensorList.msg>`
     - Tensor list containing encoded image and text tensors.

ROS Services Advertised
^^^^^^^^^^^^^^^^^^^^^^^

.. list-table::
   :header-rows: 1

   * - ROS Service
     - Interface
     - Description

   * - ``set_prompt``
     - :ir_repo:`isaac_ros_grounding_dino_interfaces/SetPrompt <isaac_ros_object_detection> <isaac_ros_grounding_dino_interfaces/srv/SetPrompt.srv>`
     - Service to set a new text prompt for object detection.

ROS Services Requested
^^^^^^^^^^^^^^^^^^^^^^

.. list-table::
   :header-rows: 1

   * - ROS Service
     - Interface
     - Description

   * - ``get_text_tokens``
     - :ir_repo:`isaac_ros_grounding_dino_interfaces/GetTextTokens <isaac_ros_object_detection> <isaac_ros_grounding_dino_interfaces/srv/GetTextTokens.srv>`
     - Service to tokenize text prompts and generate positive maps.

   * - ``sync_data_with_decoder``
     - :ir_repo:`isaac_ros_grounding_dino_interfaces/SyncDataWithDecoder <isaac_ros_object_detection> <isaac_ros_grounding_dino_interfaces/srv/SyncDataWithDecoder.srv>`
     - Service to synchronize class IDs and positive maps between the pre-processor and decoder nodes.

GroundingDinoTextTokenizer
~~~~~~~~~~~~~~~~~~~~~~~~~~

ROS Services Advertised
^^^^^^^^^^^^^^^^^^^^^^^

.. list-table::
   :header-rows: 1

   * - ROS Service
     - Interface
     - Description

   * - ``get_text_tokens``
     - :ir_repo:`isaac_ros_grounding_dino_interfaces/GetTextTokens <isaac_ros_object_detection> <isaac_ros_grounding_dino_interfaces/srv/GetTextTokens.srv>`
     - Service to tokenize text prompts into BERT tokens and generate positive maps for label-to-token mapping.

GroundingDinoDecoderNode
~~~~~~~~~~~~~~~~~~~~~~~~

ROS Parameters
^^^^^^^^^^^^^^

.. list-table::
   :header-rows: 1

   * - ROS Parameter
     - Type
     - Default
     - Description

   * - ``boxes_tensor_name``
     - ``string``
     - ``boxes``
     - The name of the boxes tensor binding in the input tensor list.

   * - ``scores_tensor_name``
     - ``string``
     - ``scores``
     - The name of the scores tensor binding in the input tensor list.

   * - ``confidence_threshold``
     - ``double``
     - ``0.5``
     - The minimum score required for a particular bounding box to be published.

   * - ``image_width``
     - ``int``
     - ``640``
     - The width of the resized image, for scaling the final bounding box to match the original dimensions.

   * - ``image_height``
     - ``int``
     - ``480``
     - The height of the resized image, for scaling the final bounding box to match the original dimensions.

ROS Topics Subscribed
^^^^^^^^^^^^^^^^^^^^^

.. list-table::
   :header-rows: 1

   * - ROS Topic
     - Interface
     - Description

   * - ``tensor_sub``
     - :ir_repo:`isaac_ros_tensor_list_interfaces/TensorList <isaac_ros_common> <isaac_ros_tensor_list_interfaces/msg/TensorList.msg>`
     - The tensor that represents the inferred aligned bounding boxes and scores.

ROS Topics Published
^^^^^^^^^^^^^^^^^^^^

.. list-table::
   :header-rows: 1

   * - ROS Topic
     - Interface
     - Description

   * - ``detections_output``
     - `vision_msgs/Detection2DArray <https://github.com/ros-perception/vision_msgs/blob/ros2/vision_msgs/msg/Detection2DArray.msg>`__
     - Aligned image bounding boxes with detection class.

ROS Services Advertised
^^^^^^^^^^^^^^^^^^^^^^^

.. list-table::
   :header-rows: 1

   * - ROS Service
     - Interface
     - Description

   * - ``sync_data_with_decoder``
     - :ir_repo:`isaac_ros_grounding_dino_interfaces/SyncDataWithDecoder <isaac_ros_object_detection> <isaac_ros_grounding_dino_interfaces/srv/SyncDataWithDecoder.srv>`
     - Service to receive and synchronize class IDs and positive maps from the pre-processor node.

.. |package_name| replace:: ``isaac_ros_grounding_dino``
