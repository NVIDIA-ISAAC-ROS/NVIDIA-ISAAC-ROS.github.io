==================================================
Tutorial for cuMotion MoveIt Plugin with Isaac Sim
==================================================

.. figure:: :ir_lfs:`<resources/isaac_ros_docs/concepts/manipulation/cumotion_moveit/isaac_sim.jpg>`
    :align: center
    :width: 800px

Overview
------------

This tutorial walks through the process of planning trajectories for a simulated Franka or UR robot
in Isaac Sim, leveraging the cuMotion plugin for MoveIt 2 provided by
:ir_repo:`Isaac ROS cuMotion <isaac_ros_cumotion>`. It is based on an
`example <https://moveit.picknik.ai/main/doc/how_to_guides/isaac_panda/isaac_panda_tutorial.html>`_
developed by PickNik Robotics, which in turn was based on a MoveIt example, with fewer features, provided
with Isaac Sim.


Tutorial Walkthrough
--------------------

Set Up Development Environment
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#. Set up your development environment by following the instructions in :doc:`Getting Started </getting_started/index>`.

Install ``isaac_ros_cumotion_moveit`` and Examples
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#. Install the ``isaac_ros_cumotion_examples`` package and its dependencies
   (including ``isaac_ros_cumotion`` and ``isaac_ros_cumotion_moveit``):

   .. include:: /repositories_and_packages/isaac_ros_cumotion/isaac_ros_cumotion_moveit/_snippets/install.rst

#. Install and configure Isaac Sim following the steps in the
   :ref:`Isaac ROS Isaac Sim Setup Guide <gs_isaac_sim>`, stopping after step 4.

#. This tutorial uses the Isaac Sim standalone workflow, in which Isaac Sim is launched using a Python script.  In the
   terminal opened using the **Open in Terminal** button in the Isaac Sim App Selector (and notably **not** in a shell
   within the Isaac ROS environment), source your ROS 2 workspace. For example:

   .. code:: bash

      source /opt/ros/:ir_ros_distro:/setup.bash

#. Set up your robot using the instructions below:

.. tabs::

   .. group-tab:: Universal Robot (UR)

      #. Start Isaac Sim and open the following scene:

         .. code:: bash

            https://omniverse-content-production.s3-us-west-2.amazonaws.com/Assets/Isaac/5.1/Isaac/Samples/ROS2/Scenario/isaac_manipulator_scene.usd


      #. **Optional:** The above scene contains a UR10e robot. If you would like to experiment with a different UR robot:
         
         #. Delete the UR10e from the scene.
         #. Find the alternative robot in Isaac Sim's robot assets folder and drag it onto the table in the scene.
         #. Edit the Action Graph so that the ``ROS2 Publish Joint State`` and ``Articulation Controller`` nodes refer to the new robot, and save the USD file.

      #. After the scene is fully loaded, click **Play**.

         .. note::

            Before launching MoveIt, ensure that the scene is loaded in Isaac Sim and that the timeline is playing.

            Running ``ros2 topic list`` in your ROS workspace should show a number of topics streaming data from
            Isaac Sim.

   .. group-tab:: Franka

      #. Start Isaac Sim and open the scene containing the Franka robot.

      #. Enable the robotics example window by clicking **Window > Examples > Robotics Examples**.

         .. figure:: :ir_lfs:`<resources/isaac_ros_docs/concepts/manipulation/cumotion_moveit/isaac_sim_enable_robotics_examples.png>`
            :align: center
            :width: 400px

      #. In the **Robotics Examples** tab, select **ROS2 > MoveIt > Franka MoveIt** and click **Load Sample Scene**.

         .. figure:: :ir_lfs:`<resources/isaac_ros_docs/concepts/manipulation/cumotion_moveit/isaac_sim_load_sample_scene.png>`
            :align: center
            :width: 400px

      #. After Isaac Sim fully loads, the timeline will begin playing automatically.

         .. note::

            The example should be loaded in Isaac Sim before MoveIt is launched.

            Running ``ros2 topic list`` in your ROS workspace should show a number of topics streaming data from
            Isaac Sim.

   .. group-tab:: Another Robot

      #. Follow the entire :doc:`Custom Manipulator tutorial </concepts/manipulation/cumotion_moveit/tutorial_custom_manipulator>`.

      #. Start Isaac Sim and open the following scene:

         .. code:: bash

            https://omniverse-content-production.s3-us-west-2.amazonaws.com/Assets/Isaac/5.1/Isaac/Samples/ROS2/Scenario/isaac_manipulator_scene.usd


      #. Delete the UR10e robot from the scene.

      #. Find your robot's USD file in Isaac Sim's robot assets folder (or use the one you made by following the
         :doc:`Custom Manipulator tutorial </concepts/manipulation/cumotion_moveit/tutorial_custom_manipulator>`)
         and drag it onto the table in the scene.

      #. In the Action Graph, edit the ``ROS2 Publish Joint State`` and ``Articulation Controller`` nodes to refer to
         the new robot.

      #. Save the USD file, and click **Play**.

         .. note::

            Before launching MoveIt, ensure that the scene is loaded in Isaac Sim and that the timeline is playing.

            Running ``ros2 topic list`` in your ROS workspace should show a number of topics streaming data from
            Isaac Sim.


Set Up MoveIt 2 with cuMotion
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. tabs::

   .. group-tab:: Universal Robot (UR)

      .. note::

         If you are using a UR robot other than UR5e or UR10e, follow the
         :ref:`Creating an XRDF file for a Custom Manipulator <concepts/manipulation/cumotion_moveit/tutorial_custom_manipulator:Creating an XRDF file for a Custom Manipulator>`
         section of the
         :doc:`Custom Manipulator tutorial </concepts/manipulation/cumotion_moveit/tutorial_custom_manipulator>`
         before proceeding to the instructions below.

         The Isaac Sim scene contains a UR10e by default and will have to be modified for other robots.
         Refer to section above.

      #. Open a new terminal inside the Isaac ROS environment.

         .. code:: bash

            isaac-ros activate

      #. Launch MoveIt (including RViz) using the provided launch file.  Remember to first run
         ``source install/setup.bash`` if package was built from source.

         .. code:: bash

            ros2 launch isaac_ros_cumotion_examples ur_isaac_sim.launch.py ur_type:=<UR_TYPE>

         .. note::

            Replace ``<UR_TYPE>`` with the type of your UR robot (for example, ``ur10e``).

         The visualization of the robot in RViz should reflect the current joint state of the
         simulated robot in Isaac Sim.


   .. group-tab:: Franka

      #. Open a new terminal inside the Isaac ROS environment.

         .. code:: bash

            isaac-ros activate

      #. Launch cuMotion planner node and MoveIt (including RViz) using the provided launch file. Remember to first run ``source install/setup.bash``
         if package was built from source.

         .. code:: bash

            ros2 launch isaac_ros_cumotion_examples franka_isaac_sim.launch.py

         Verify that the visualization of the robot in RViz reflects the current joint state of the
         simulated robot in Isaac Sim.

   .. group-tab:: Another Robot

      1. Open a new terminal inside the Isaac ROS environment.

         .. code:: bash

            isaac-ros activate

      #. Launch MoveIt (including RViz) using the launch file you created in the :doc:`Custom Manipulator tutorial </concepts/manipulation/cumotion_moveit/tutorial_custom_manipulator>`. Remember to first run ``source install/setup.bash``
         if the package was built from source.

         .. code:: bash

            ros2 launch <PACKAGE_CONTAINING_LAUNCH_FILE> <ROBOT>.launch.py

         Verify that the visualization of the robot in RViz reflects the current joint state of the
         simulated robot in Isaac Sim.

      #. Open another terminal inside the Isaac ROS environment.

         .. code:: bash

            isaac-ros activate

      #. Run the cuMotion planner node. Remember to first run ``source install/setup.bash`` if package was built
         from source.

         .. code:: bash

            ros2 run isaac_ros_cumotion cumotion_planner_node --ros-args \
               -p robot:=<FULL_PATH_TO_XRDF> \
               -p urdf_path:=<FULL_PATH_TO_URDF>


Using the cuMotion Planner in MoveIt
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#. In RViz, enable cuMotion by ensuring that ``isaac_ros_cumotion`` and ``cuMotion`` are selected within the
   **Planning Library** pane within the **Context** tab in the bottom left corner of the RViz window.

   .. figure:: :ir_lfs:`<resources/isaac_ros_docs/repositories_and_packages/isaac_ros_cumotion/isaac_ros_cumotion_moveit/moveit_context.png>`
      :align: center

#. Select a target pose for the robot end effector and click the **Plan** button in the **Planning** tab.
   If planning is successful, an animation of the trajectory will be visualized in RViz.

#. Click the **Execute** button in RViz. The simulated robot in Isaac Sim will follow the motion of
   the robot in RViz.
